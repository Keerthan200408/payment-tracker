<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Tracking App</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
  <link rel="stylesheet" href="./src/output.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script>
    window.addEventListener('error', (e) => {
      console.error('Script load failed:', e.message, e.filename);
    });
  </script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    console.log('Starting React app...');
    const { useState, useEffect, useRef } = React;
    const BASE_URL = 'https://payment-tracker-aswa.onrender.com';

    const ErrorBoundary = ({ children }) => {
      const [hasError, setHasError] = useState(false);
      const [error, setError] = useState(null);
      useEffect(() => {
        const errorHandler = (e) => {
          console.error('ErrorBoundary caught:', e.error);
          setHasError(true);
          setError(e.error);
        };
        window.addEventListener('error', errorHandler);
        return () => window.removeEventListener('error', errorHandler);
      }, []);
      if (hasError) {
        return (
          <div className="p-4 bg-red-100 text-red-700 rounded-lg m-4">
            <h2 className="text-xl font-bold">Something went wrong.</h2>
            <p>{error?.toString()}</p>
            <button
              onClick={() => window.location.reload()}
              className="mt-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
            >
              Reload Page
            </button>
          </div>
        );
      }
      return children;
    };

    const App = () => {
      const [sessionToken, setSessionToken] = useState(null);
      const [currentUser, setCurrentUser] = useState(null);
      const [page, setPage] = useState('signIn');
      const [clientsData, setClientsData] = useState([]);
      const [paymentsData, setPaymentsData] = useState([]);
      const csvFileInputRef = useRef(null);

      useEffect(() => {
        const storedUser = localStorage.getItem('currentUser');
        const storedToken = localStorage.getItem('sessionToken');
        if (storedUser && storedToken) {
          setCurrentUser(storedUser);
          setSessionToken(storedToken);
          setPage('home');
          fetchClients(storedToken);
          fetchPayments(storedToken);
        }
      }, []);

      const fetchWithRetry = async (url, options, retries = 3) => {
        for (let i = 0; i < retries; i++) {
          try {
            const response = await axios.get(url, options);
            return response;
          } catch (error) {
            if (i === retries - 1) throw error;
            console.log(`Retrying ${url} (${i + 1}/${retries})...`);
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
      };

      const fetchClients = async (token) => {
        try {
          const response = await fetchWithRetry(`${BASE_URL}/api/get-clients`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          setClientsData(response.data);
        } catch (error) {
          console.error('Error fetching clients:', error);
          handleSessionError(error);
        }
      };

      const fetchPayments = async (token) => {
        try {
          const response = await fetchWithRetry(`${BASE_URL}/api/get-payments`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          setPaymentsData(response.data);
        } catch (error) {
          console.error('Error fetching payments:', error);
          handleSessionError(error);
        }
      };

      const handleSessionError = (error) => {
        console.log('Session error:', error.response?.status, error.response?.data);
        if (error.response && error.response.status === 401) {
          logout();
        }
      };

      const logout = () => {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('sessionToken');
        setSessionToken(null);
        setCurrentUser(null);
        setPage('signIn');
        setClientsData([]);
        setPaymentsData([]);
      };

      const importCsv = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (event) => {
          const text = event.target.result;
          const rows = text.split('\n').map(row => row.trim()).filter(row => row);
          if (rows.length === 0) {
            alert('CSV file is empty.');
            csvFileInputRef.current.value = '';
            return;
          }
          const data = rows.map(row => {
            const cols = row.split(',').map(col => col.trim());
            return {
              Client_Name: cols[0] || 'Unknown Client',
              Type: cols[1] || 'Unknown Type',
              Amount_To_Be_Paid: cols[2] || '0',
            };
          });
          try {
            await axios.post(`${BASE_URL}/api/import-csv`, data, {
              headers: { Authorization: `Bearer ${sessionToken}` },
            });
            fetchClients(sessionToken);
            fetchPayments(sessionToken);
            alert('CSV data imported successfully!');
            csvFileInputRef.current.value = '';
          } catch (error) {
            console.error('Error importing CSV:', error);
            alert('Failed to import CSV data: ' + error.message);
            csvFileInputRef.current.value = '';
          }
        };
        reader.readAsText(file);
      };

      console.log('App rendering, page:', page);
      return (
        <div className="min-h-screen bg-gray-50">
          {page === 'signIn' && (
            <>
              <SignInPage setSessionToken={setSessionToken} setCurrentUser={setCurrentUser} setPage={setPage} />
              <div className="text-center mt-4 text-red-500">Debug: SignInPage should be above</div>
            </>
          )}
          {page !== 'signIn' && (
            <div>
              <nav className="bg-teal-600 text-white p-5 flex justify-between items-center shadow-md">
                <div className="space-x-6">
                  <button onClick={() => setPage('home')} className="text-lg hover:text-teal-100 transition duration-200">Home</button>
                  <button onClick={() => setPage('clients')} className="text-lg hover:text-teal-100 transition duration-200">Clients</button>
                  <button onClick={() => setPage('addClient')} className="text-lg hover:text-teal-100 transition duration-200">Add Client</button>
                  <button onClick={() => setPage('payments')} className="text-lg hover:text-teal-100 transition duration-200">Payments</button>
                  <label className="text-lg hover:text-teal-100 transition duration-200 cursor-pointer">
                    Import CSV
                    <input
                      type="file"
                      accept=".csv"
                      onChange={importCsv}
                      ref={csvFileInputRef}
                      className="hidden"
                    />
                  </label>
                </div>
                <div className="space-x-6">
                  <span className="text-lg">Welcome, {currentUser}</span>
                  <button onClick={logout} className="text-lg hover:text-teal-100 transition duration-200">Logout</button>
                </div>
              </nav>
              <div className="p-8">
                {page === 'home' && (
                  <HomePage clientsData={clientsData} paymentsData={paymentsData} />
                )}
                {page === 'clients' && (
                  <ClientsPage
                    clientsData={clientsData}
                    setPage={setPage}
                    fetchClients={fetchClients}
                    sessionToken={sessionToken}
                    handleSessionError={handleSessionError}
                  />
                )}
                {page === 'addClient' && (
                  <AddClientPage
                    setPage={setPage}
                    fetchClients={fetchClients}
                    sessionToken={sessionToken}
                    handleSessionError={handleSessionError}
                  />
                )}
                {page === 'payments' && (
                  <PaymentsPage
                    paymentsData={paymentsData}
                    fetchPayments={fetchPayments}
                    sessionToken={sessionToken}
                    handleSessionError={handleSessionError}
                  />
                )}
              </div>
            </div>
          )}
          <div className="text-center mt-4">Debug: App rendered, current page: {page}</div>
        </div>
      );
    };

    const SignInPage = ({ setSessionToken, setCurrentUser, setPage }) => {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [isLogin, setIsLogin] = useState(true);
      console.log('Rendering SignInPage');
      const handleLogin = async () => {
        try {
          console.log('Attempting login with:', { username, password });
          const response = await axios.post(`${BASE_URL}/api/login`, { username, password });
          console.log('Login response:', response.data);
          setCurrentUser(response.data.username);
          setSessionToken(response.data.sessionToken);
          localStorage.setItem('currentUser', response.data.username);
          localStorage.setItem('sessionToken', response.data.sessionToken);
          setPage('home');
        } catch (error) {
          console.error('Login error:', error.response?.data || error.message);
          alert(error.response?.data?.error || 'Error logging in');
        }
      };
      const handleSignup = async () => {
        try {
          const response = await axios.post(`${BASE_URL}/api/signup`, { username, password });
          alert('Signup successful! Please login.');
          setIsLogin(true);
        } catch (error) {
          alert(error.response?.data?.error || 'Error signing up');
        }
      };
      return (
        <div className="max-w-md mx-auto mt-24 p-8 bg-white rounded-xl shadow-xl">
          <div>Debug: SignInPage is rendering</div>
          <h2 className="text-3xl font-bold mb-6 text-teal-600">{isLogin ? 'Login' : 'Sign Up'}</h2>
          <input
            type="text"
            value={username}
            onChange={(e) => setUsername(e.target.value)}
            placeholder="Username"
            className="w-full p-3 mb-5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition"
          />
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="Password"
            className="w-full p-3 mb-5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition"
          />
          <button
            onClick={isLogin ? handleLogin : handleSignup}
            className="w-full p-3 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition duration-200 font-semibold"
          >
            {isLogin ? 'Login' : 'Sign Up'}
          </button>
          <p className="mt-5 text-center text-gray-600">
            {isLogin ? "Don't have an account?" : 'Already have an account?'}
            <button
              onClick={() => setIsLogin(!isLogin)}
              className="text-teal-500 hover:underline ml-1"
            >
              {isLogin ? 'Sign Up' : 'Login'}
            </button>
          </p>
        </div>
      );
    };

    const HomePage = ({ clientsData, paymentsData }) => {
      const totalClients = clientsData.length;
      const totalPaymentsDue = paymentsData.reduce((sum, payment) => sum + (parseFloat(payment[16]) || 0), 0);
      return (
        <div>
          <h2 className="text-3xl font-bold mb-6 text-gray-800">Dashboard</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="p-6 bg-white rounded-xl shadow-xl">
              <h3 className="text-xl font-semibold text-gray-700">Total Clients</h3>
              <p className="text-3xl font-bold text-teal-600 mt-2">{totalClients}</p>
            </div>
            <div className="p-6 bg-white rounded-xl shadow-xl">
              <h3 className="text-xl font-semibold text-gray-700">Total Payments Due</h3>
              <p className="text-3xl font-bold text-red-500 mt-2">₹{totalPaymentsDue.toFixed(2)}</p>
            </div>
          </div>
        </div>
      );
    };

    const ClientsPage = ({ clientsData, setPage, fetchClients, sessionToken, handleSessionError }) => {
      const [editingClient, setEditingClient] = useState(null);
      const [clientName, setClientName] = useState('');
      const [clientEmail, setClientEmail] = useState('');
      const [clientType, setClientType] = useState('subscription');
      const [monthlyPayment, setMonthlyPayment] = useState('');

      const handleEdit = (client) => {
        setEditingClient(client);
        setClientName(client[1]);
        setClientEmail(client[2]);
        setClientType(client[3]);
        setMonthlyPayment(client[4]);
      };

      const handleUpdate = async () => {
        try {
          await axios.post(`${BASE_URL}/api/update-client`, {
            oldClient: editingClient,
            newClient: [editingClient[0], clientName, clientEmail, clientType, monthlyPayment],
          }, {
            headers: { Authorization: `Bearer ${sessionToken}` },
          });
          setEditingClient(null);
          fetchClients(sessionToken);
        } catch (error) {
          handleSessionError(error);
        }
      };

      const handleDelete = async (client) => {
        if (window.confirm(`Are you sure you want to delete ${client[1]}?`)) {
          try {
            await axios.post(`${BASE_URL}/api/delete-client`, { client }, {
              headers: { Authorization: `Bearer ${sessionToken}` },
            });
            fetchClients(sessionToken);
          } catch (error) {
            handleSessionError(error);
          }
        }
      };

      return (
        <div>
          <h2 className="text-3xl font-bold mb-6 text-gray-800">Clients</h2>
          <div className="overflow-x-auto">
            <table className="min-w-full bg-white border border-gray-200 rounded-xl shadow-xl">
              <thead className="bg-gray-100">
                <tr>
                  <th className="border-b border-gray-200 p-4 text-left text-gray-600 font-semibold">Client Name</th>
                  <th className="border-b border-gray-200 p-4 text-left text-gray-600 font-semibold">Email</th>
                  <th className="border-b border-gray-200 p-4 text-left text-gray-600 font-semibold">Type</th>
                  <th className="border-b border-gray-200 p-4 text-left text-gray-600 font-semibold">Monthly Payment</th>
                  <th className="border-b border-gray-200 p-4 text-left text-gray-600 font-semibold">Actions</th>
                </tr>
              </thead>
              <tbody>
                {clientsData.map((client, index) => (
                  <tr key={index} className="hover:bg-gray-50 transition">
                    <td className="border-b border-gray-200 p-4 text-gray-800">{client[1]}</td>
                    <td className="border-b border-gray-200 p-4 text-gray-600">{client[2]}</td>
                    <td className="border-b border-gray-200 p-4 text-gray-600">{client[3]}</td>
                    <td className="border-b border-gray-200 p-4 text-gray-600">₹{client[4]}</td>
                    <td className="border-b border-gray-200 p-4">
                      <button
                        onClick={() => handleEdit(client)}
                        className="text-teal-500 hover:text-teal-700 transition duration-200 mr-3 font-semibold"
                      >
                        Edit
                      </button>
                      <button
                        onClick={() => handleDelete(client)}
                        className="text-red-500 hover:text-red-700 transition duration-200 font-semibold"
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          {editingClient && (
            <div className="mt-8 p-6 bg-white rounded-xl shadow-xl">
              <h3 className="text-xl font-semibold mb-5 text-gray-800">Edit Client</h3>
              <input
                type="text"
                value={clientName}
                onChange={(e) => setClientName(e.target.value)}
                placeholder="Client Name"
                className="w-full p-3 mb-5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition"
              />
              <input
                type="email"
                value={clientEmail}
                onChange={(e) => setClientEmail(e.target.value)}
                placeholder="Email"
                className="w-full p-3 mb-5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition"
              />
              <select
                value={clientType}
                onChange={(e) => setClientType(e.target.value)}
                className="w-full p-3 mb-5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition"
              >
                <option value="subscription">Subscription</option>
                <option value="one-time">One-Time</option>
              </select>
              <input
                type="number"
                value={monthlyPayment}
                onChange={(e) => setMonthlyPayment(e.target.value)}
                placeholder="Monthly Payment"
                className="w-full p-3 mb-5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition"
              />
              <button
                onClick={handleUpdate}
                className="w-full p-3 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition duration-200 font-semibold"
              >
                Update Client
              </button>
              <button
                onClick={() => setEditingClient(null)}
                className="w-full p-3 mt-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200 font-semibold"
              >
                Cancel
              </button>
            </div>
          )}
        </div>
      );
    };

    const AddClientPage = ({ setPage, fetchClients, sessionToken, handleSessionError }) => {
      const [clientName, setClientName] = useState('');
      const [clientEmail, setClientEmail] = useState('');
      const [clientType, setClientType] = useState('subscription');
      const [monthlyPayment, setMonthlyPayment] = useState('');

      const handleSubmit = async () => {
        try {
          await axios.post(`${BASE_URL}/api/add-client`, {
            client: [null, clientName, clientEmail, clientType, monthlyPayment],
          }, {
            headers: { Authorization: `Bearer ${sessionToken}` },
          });
          fetchClients(sessionToken);
          setPage('clients');
        } catch (error) {
          handleSessionError(error);
        }
      };

      return (
        <div>
          <h2 className="text-3xl font-bold mb-6 text-gray-800">Add Client</h2>
          <div className="p-6 bg-white rounded-xl shadow-xl">
            <input
              type="text"
              value={clientName}
              onChange={(e) => setClientName(e.target.value)}
              placeholder="Client Name"
              className="w-full p-3 mb-5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition"
            />
            <input
              type="email"
              value={clientEmail}
              onChange={(e) => setClientEmail(e.target.value)}
              placeholder="Email"
              className="w-full p-3 mb-5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition"
            />
            <select
              value={clientType}
              onChange={(e) => setClientType(e.target.value)}
              className="w-full p-3 mb-5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition"
            >
              <option value="subscription">Subscription</option>
              <option value="one-time">One-Time</option>
            </select>
            <input
              type="number"
              value={monthlyPayment}
              onChange={(e) => setMonthlyPayment(e.target.value)}
              placeholder="Monthly Payment"
              className="w-full p-3 mb-5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition"
            />
            <button
              onClick={handleSubmit}
              className="w-full p-3 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition duration-200 font-semibold"
            >
              Add Client
            </button>
            <button
              onClick={() => setPage('clients')}
              className="w-full p-3 mt-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200 font-semibold"
            >
              Cancel
            </button>
          </div>
        </div>
      );
    };

    const PaymentsPage = ({ paymentsData, fetchPayments, sessionToken, handleSessionError }) => {
      const [monthPayments, setMonthPayments] = useState({});
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      const handlePaymentChange = (index, monthIndex, value) => {
        setMonthPayments(prev => ({
          ...prev,
          [index]: {
            ...prev[index],
            [monthIndex]: value,
          },
        }));
      };

      const handleSavePayments = async () => {
        try {
          const updatedPayments = paymentsData.map((payment, index) => {
            const updatedRow = [...payment];
            for (let i = 0; i < 12; i++) {
              updatedRow[4 + i] = monthPayments[index]?.[i] || payment[4 + i] || '';
            }
            return updatedRow;
          });
          await axios.post(`${BASE_URL}/api/save-payments`, { payments: updatedPayments }, {
            headers: { Authorization: `Bearer ${sessionToken}` },
          });
          fetchPayments(sessionToken);
          setMonthPayments({});
          alert('Payments saved successfully!');
        } catch (error) {
          handleSessionError(error);
        }
      };

      return (
        <div>
          <h2 className="text-3xl font-bold mb-6 text-gray-800">Payments</h2>
          <div className="overflow-x-auto">
            <table className="min-w-full bg-white border border-gray-200 rounded-xl shadow-xl">
              <thead className="bg-gray-100">
                <tr>
                  <th className="border-b border-gray-200 p-4 text-left text-gray-600 font-semibold">Client Name</th>
                  <th className="border-b border-gray-200 p-4 text-left text-gray-600 font-semibold">Type</th>
                  <th className="border-b border-gray-200 p-4 text-left text-gray-600 font-semibold">Amount</th>
                  {months.map((month, idx) => (
                    <th key={idx} className="border-b border-gray-200 p-4 text-left text-gray-600 font-semibold">{month}</th>
                  ))}
                  <th className="border-b border-gray-200 p-4 text-left text-gray-600 font-semibold">Due Payment</th>
                </tr>
              </thead>
              <tbody>
                {paymentsData.map((payment, index) => (
                  <tr key={index} className="hover:bg-gray-50 transition">
                    <td className="border-b border-gray-200 p-4 text-gray-800">{payment[1]}</td>
                    <td className="border-b border-gray-200 p-4 text-gray-600">{payment[2]}</td>
                    <td className="border-b border-gray-200 p-4 text-gray-600">₹{payment[3]}</td>
                    {months.map((_, monthIndex) => (
                      <td key={monthIndex} className="border-b border-gray-200 p-4">
                        <input
                          type="checkbox"
                          checked={
                            (monthPayments[index]?.[monthIndex] !== undefined
                              ? monthPayments[index]?.[monthIndex]
                              : payment[4 + monthIndex]) || false
                          }
                          onChange={(e) => handlePaymentChange(index, monthIndex, e.target.checked)}
                          className="h-5 w-5 text-teal-500 rounded focus:ring-teal-500"
                        />
                      </td>
                    ))}
                    <td className="border-b border-gray-200 p-4 text-gray-600">₹{payment[16]}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <button
            onClick={handleSavePayments}
            className="mt-6 p-3 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition duration-200 font-semibold"
          >
            Save Payments
          </button>
        </div>
      );
    };

    ReactDOM.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>,
      document.getElementById('root'),
      () => console.log('ReactDOM.render completed')
    );
  </script>
</body>
</html>